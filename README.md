# sleep-hrv-analyzer
睡眠・HRVデータ分析アプリ - 微分積分アプローチによる日中心拍変動解析
# 睡眠・HRVデータ分析アプリ_Ver2 セットアップガイド

## 概要

このアプリケーションは、Apple WatchなどのウェアラブルデバイスからエクスポートされたAutoSleepデータ（睡眠記録）とHRVデータ（心拍変動）を統合・分析し、睡眠の質と日中の自律神経バランスの関係を可視化するツールです。

Ver2では、日中HRV平均値の計算に微分積分アプローチが導入され、より正確な時間加重平均を算出できるようになりました。

## 特徴

- 睡眠データとHRVデータの統合分析
- グラフィカルユーザーインターフェース（GUI）による操作
- 微分積分アプローチによる時間加重HRV平均値計算
- 分析結果のPDF出力機能

## 環境要件

- Python 3.7以上
- 必要なパッケージ:
  - PyQt5
  - pandas
  - reportlab

## インストール方法

### 1. リポジトリのクローンまたはダウンロード

```bash
git clone https://github.com/yourusername/sleep-hrv-analyzer.git
cd sleep-hrv-analyzer
```

または、提供されたZIPファイルを解凍してください。

### 2. 必要なパッケージのインストール

```bash
pip install PyQt5 pandas reportlab
```

### 3. ディレクトリ構造の確認

以下のような構造になっていることを確認してください：

```
sleep_hrv_analyzer/
├── main.py
├── data_processor.py
├── ui/
│   ├── __init__.py
│   ├── main_window.py
│   └── widgets.py
└── utils/
    ├── __init__.py
    ├── file_parser.py
    ├── date_utils.py
    └── pdf_generator.py
```

## 使用方法

### 1. アプリケーションの起動

```bash
python main.py
```

### 2. データファイルの選択

1. 「AutoSleepファイル選択」ボタンをクリックし、AutoSleepのCSVファイルを選択します
2. 「HRVファイル選択」ボタンをクリックし、HRVデータのCSVファイルを選択します

### 3. 分析の実行

「分析実行」ボタンをクリックし、処理が完了するまで待ちます

### 4. 結果の確認

分析結果がテーブルに表示されます：
- 日付
- 就寝時間
- 起床時間
- 日中HRV平均値（微分積分アプローチで計算）
- 平均呼吸レート
- 睡眠時間

### 5. PDF出力

「PDF出力」ボタンをクリックし、保存先を指定することでレポートをPDF形式で保存できます

## 入力ファイルの形式

### AutoSleepデータCSV

以下の列が必要です：
- 就寝時間（例：2025-03-02 午後9:56:00）
- 起床時間（例：2025-03-03 午前6:30:00）
- 平均呼吸（オプション）
- 睡眠（睡眠時間、オプション）

### HRVデータCSV

1行目：「Heart Rate Variability (ms)」などのヘッダー情報
2行目：「Date,12 AM - 1 AM,1 AM - 2 AM,...」のような時間帯カラム
3行目以降：日付と各時間帯のHRV値

## Ver2の新機能：微分積分による日中HRV平均値計算

従来のアプローチでは、各時間帯のHRV値の単純平均を計算していましたが、Ver2では以下の特徴をもつ微分積分アプローチが導入されました：

1. **時間間隔の考慮** - 測定値間の時間間隔を重み付けに使用
2. **連続的変化の表現** - 測定値間の変化を直線補間
3. **台形積分** - 各時間区間ごとに台形法による積分計算

### 計算方法

1. 起床時間から次の就寝時間までの各HRV測定値とその時間を抽出
2. 時間順にソート
3. 隣接する時間帯ごとに台形積分を計算：(値1 + 値2) / 2 × 時間間隔
4. 全区間の積分値の合計を全時間で割って平均値を算出

例：3月2日の場合（起床8時、次の就寝22時）
- 8:00-9:00: 63.86
- 11:00-12:00: 70.75
- 14:00-15:00: 61.21
- 18:00-19:00: 59.065
- 22:00-23:00: 38.54

微分積分アプローチでの計算結果：59.69 ms
（従来の単純平均：58.69 ms）

## トラブルシューティング

### ファイル形式エラー

CSVファイルのエンコーディングが正しく認識されない場合：
- UTF-8
- Shift-JIS
- CP932
を自動で試行します。

### 日時解析エラー

日本語の「午前」「午後」表記を含む日時が解析できない場合：
- 日付形式（「YYYY-MM-DD」）と時間形式（「午前/午後HH:MM:SS」）が正しいことを確認
- ログファイル（logs/app.log）で詳細なエラーメッセージを確認

## ライセンス

このアプリケーションはMITライセンスの下で公開されています。

## 協力者

- 開発：あなたの名前
- 特別な謝辞：微分積分アプローチの実装に協力してくださった方々
